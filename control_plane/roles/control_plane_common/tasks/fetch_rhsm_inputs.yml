#  Copyright 2022 Dell Inc. or its subsidiaries. All Rights Reserved.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
---

- name: Include rhsm_vars.yml file
  include_vars: "{{ rhsm_vars_filename }}"

- name: Validate rhsm_support
  assert:
    that: (rhsm_support | lower == "true") or (rhsm_support | lower  == "false")
  register: failure_msg
  no_log: true

- block:
  - name: Validate redhat_subscription_method
    assert:
      that: (redhat_subscription_method | lower == "portal") or (redhat_subscription_method | lower  == "satellite")
      fail_msg: "{{ rhsm_method_fail_msg }}"
    register: failure_msg
    no_log: true

  - name: Validate redhat_subscription_autosubscribe
    assert:
      that:
        - (redhat_subscription_autosubscribe | lower == "true") or (redhat_subscription_autosubscribe | lower == "false")
      fail_msg: "{{ rhsm_autosubscribe_fail_msg }}"
    register: failure_msg
    no_log: true
    when: redhat_subscription_method | lower == "portal"

  - name: Validate redhat_subscription_force_register
    assert:
      that:
        - (redhat_subscription_force_register | lower == "true") or (redhat_subscription_force_register | lower == "false")
      fail_msg: "{{ rhsm_force_register_fail_msg }}"
    register: failure_msg
    no_log: true

  - name: Validate redhat_subscription_repos_state
    assert:
      that:
        - (redhat_subscription_repos_state | lower == "enabled") or (redhat_subscription_repos_state | lower == "disabled")
      fail_msg: "{{ rhsm_repos_state_fail_msg }}"
    register: failure_msg
    no_log: true
    when: redhat_subscription_repos | default("", true) | length > 1

  - name: Validate redhat_subscription_repos_purge
    assert:
      that:
        - (redhat_subscription_repos_purge | lower == "true") or (redhat_subscription_repos_purge | lower == "false")
      fail_msg: "{{ rhsm_repos_purge_fail_msg }}"
    register: failure_msg
    no_log: true
    when: redhat_subscription_repos | default("", true) | length > 1

  - name: Validate redhat_subscription_port
    assert:
      that:
        - (redhat_subscription_port == 443) or (redhat_subscription_port == 8443)
      fail_msg: "{{ rhsm_rhsm_port_fail_msg }}"
    register: failure_msg
    no_log: true

  - name: Validate redhat_subscription_insecure
    assert:
      that:
        - (redhat_subscription_insecure | lower == "true") or (redhat_subscription_insecure | lower == "false")
      fail_msg: "{{ rhsm_insecure_fail_msg }}"
    register: failure_msg
    no_log: true

  - name: Validate redhat_subscription_proxy_proto
    assert:
      that:
        - (redhat_subscription_proxy_proto | lower == "http") or (redhat_subscription_proxy_proto | lower == "https")
      fail_msg: "{{ rhsm_rhsm_proxy_proto_fail_msg }}"
    register: failure_msg
    no_log: true

  - name: Validate redhat_subscription_manage_repos, redhat_subscription_full_refresh_on_yum, redhat_subscription_report_package_profile
    assert:
      that:
        - (redhat_subscription_manage_repos | lower == "true") or (redhat_subscription_manage_repos | lower == "false")
        - (redhat_subscription_full_refresh_on_yum | lower == "true") or (redhat_subscription_full_refresh_on_yum | lower == "false")
        - (redhat_subscription_report_package_profile | lower == "true") or (redhat_subscription_report_package_profile | lower == "false")
      fail_msg: "{{ rhsm_rhsm_options_fail_msg }}"
    register: failure_msg
    no_log: true

  when:
    - rhsm_support | lower == "true"

  rescue:
    - name: Show failure msg
      fail:
        msg: "{{ failure_msg.msg }}"

  when:
    - rhsm_support | lower == "true"
