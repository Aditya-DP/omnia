#  Copyright 2025 Dell Inc. or its subsidiaries. All Rights Reserved.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.

# VMAgent - VictoriaMetrics agent for scraping metrics via operator
# Managed by victoria-metrics-operator

apiVersion: operator.victoriametrics.com/v1beta1
kind: VMAgent
metadata:
  name: vmagent
  namespace: {{ telemetry_namespace }}
spec:
  # Service account for kubernetes service discovery
  serviceAccountName: {{ vmagent.service_account_name }}
  
  # Replica count
  replicaCount: 1
  
  # Image configuration
  image:
    repository: {{ vmagent.image.split(':')[0] }}
    tag: {{ vmagent.image.split(':')[1] }}
    pullPolicy: IfNotPresent
  
  # Remote write configuration - depends on deployment mode
  remoteWrite:
{% if victoria_cluster.enabled %}
    - url: {{ vmagent.remote_write_url_cluster }}
{% else %}
    - url: {{ vmagent.remote_write_url }}
      tlsConfig:
        insecureSkipVerify: true
{% endif %}
  
  # Resource limits
  resources:
    requests:
      memory: "512Mi"
      cpu: "250m"
    limits:
      memory: "1Gi"
      cpu: "1000m"
  
  # Service discovery configs
  serviceScrapeNamespaceSelector: {}
  serviceScrapeSelector: {}
  podScrapeNamespaceSelector: {}
  podScrapeSelector: {}
  
  # Additional scrape configs from ConfigMap
  additionalScrapeConfigs:
    name: {{ vmagent.configmap_name }}
    key: prometheus.yml
  
  # Extra args
  extraArgs:
    promscrape.streamParse: "true"
    promscrape.maxScrapeSize: "16MB"
