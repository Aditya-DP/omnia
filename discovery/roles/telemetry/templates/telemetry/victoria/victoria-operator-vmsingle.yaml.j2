#  Copyright 2025 Dell Inc. or its subsidiaries. All Rights Reserved.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.

# VMSingle - VictoriaMetrics single-node deployment via operator
# Managed by victoria-metrics-operator

apiVersion: operator.victoriametrics.com/v1beta1
kind: VMSingle
metadata:
  name: victoria-single
  namespace: {{ telemetry_namespace }}
spec:
  # Replica count for single-node (always 1)
  replicaCount: 1
  
  # Retention period from telemetry_config.yml
  retentionPeriod: "{{ hostvars['localhost']['victoria_configurations']['retention_period'] }}h"
  
  # Storage configuration
  storage:
    accessModes:
      - ReadWriteOnce
    resources:
      requests:
        storage: {{ hostvars['localhost']['victoria_configurations']['persistence_size'] }}
  
  # Image configuration
  image:
    repository: {{ victoria.image.split(':')[0] }}
    tag: {{ victoria.image.split(':')[1] }}
    pullPolicy: IfNotPresent
  
  # Port configuration
  port: "8428"
  
  # Resource limits
  resources:
    requests:
      memory: "2Gi"
      cpu: "500m"
    limits:
      memory: "4Gi"
      cpu: "2000m"
  
  # Pod anti-affinity for HA
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                    - vmsingle
            topologyKey: "kubernetes.io/hostname"
  
  # Tolerations for node failures
  tolerations:
    - effect: NoExecute
      key: node.kubernetes.io/not-ready
      operator: Exists
      tolerationSeconds: 5
    - effect: NoExecute
      key: node.kubernetes.io/unreachable
      operator: Exists
      tolerationSeconds: 5
  
  # Init container to clean up stale lock files
  initContainers:
    - name: cleanup-victoria-locks
      image: {{ victoria.image }}
      command:
        - /bin/sh
        - -c
        - |
          echo "Checking for stale VictoriaMetrics lock files..."
          rm -f /victoria-metrics-data/flock.lock 2>/dev/null || true
          echo "Lock file cleanup complete"
      volumeMounts:
        - name: data
          mountPath: /victoria-metrics-data

  # Service configuration
  extraArgs:
    selfScrapeInterval: "5s"
