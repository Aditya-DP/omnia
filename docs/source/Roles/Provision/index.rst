Provision
=========


1. Edit the *omnia/input/provision_config.yml* file to update the required variables.

+----------------------------------+---------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+
| Name                             | Default, Accepted Values                    | Required? | Additional Information                                                                                                                                                                                                                                                                                                          | Roles     |
+==================================+=============================================+===========+=================================================================================================================================================================================================================================================================================================================================+===========+
| public_nic                       | eno2                                        | TRUE      | The NIC/ethernet card that is connected to the public internet.                                                                                                                                                                                                                                                                 | Provision |
+----------------------------------+---------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+
| admin_nic                        | eno1                                        | TRUE      | The NIC/ethernet card that is used for shared LAN over Management (LOM)   capability.                                                                                                                                                                                                                                           | Provision |
+----------------------------------+---------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+
| admin_nic_subnet                 | 172.29.0.0                                  | TRUE      | The intended subnet for shared LOM capability.                                                                                                                                                                                                                                                                                  | Provision |
+----------------------------------+---------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+
| pxe_nic                          | eno1                                        | TRUE      | This NIC used to obtain routing information.                                                                                                                                                                                                                                                                                    | Provision |
+----------------------------------+---------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+
| pxe_nic_start_range              | 172.29.0.100                                | TRUE      | The start of the DHCP  range used   to assign IPv4 addresses                                                                                                                                                                                                                                                                    | Provision |
+----------------------------------+---------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+
| pxe_nic_end_range                | 172.29.0.200                                | TRUE      | The end of the DHCP  range used to   assign IPv4 addresses                                                                                                                                                                                                                                                                      | Provision |
+----------------------------------+---------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+
| ib_nic_subnet                    |                                             | FALSE     | If provided, Omnia will assign static IPs to IB NICs on the compute nodes   within the provided subnet.                                                                                                                                                                                                                         | Provision |
+----------------------------------+---------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+
| bmc_nic_subnet                   |                                             | FALSE     | If provided, Omnia will assign static IPs to IB NICs on the compute nodes   within the provided subnet.                                                                                                                                                                                                                         | Provision |
+----------------------------------+---------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+
| pxe_mapping_file_path            |                                             | FALSE     | The mapping file consists of the MAC address and its respective IP   address and hostname. If static IPs are required, create a csv file in the   format MAC,Hostname,IP. A sample file is provided here:   omnia/examples/host_mapping_file_os_provisioning.csv. If not provided, ensure   that ``pxe_switch_ip`` is provided. | Provision |
+----------------------------------+---------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+
| pxe_switch_ip                    |                                             | FALSE     | PXE switch that will be connected to all iDRACs for provisioning                                                                                                                                                                                                                                                                | Provision |
+----------------------------------+---------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+
| pxe_switch_snmp_community_string | public                                      | FALSE     | The SNMP community string used to access statistics, MAC addresses and   IPs stored within a router or other device.                                                                                                                                                                                                            | Provision |
+----------------------------------+---------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+
| node_name                        | node                                        | TRUE      | The intended node name for nodes in the cluster.                                                                                                                                                                                                                                                                                | Provision |
+----------------------------------+---------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+
| domain_name                      |                                             | TRUE      | DNS domain name to be set for iDRAC.                                                                                                                                                                                                                                                                                            | Provision |
+----------------------------------+---------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+
| provision_os                     | rocky,rhel                                  | TRUE      | The operating system image that will be used for provisioning compute   nodes in the cluster.                                                                                                                                                                                                                                   | Provision |
+----------------------------------+---------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+
| iso_file_path                    | /home/RHEL-8.4.0-20210503.1-x86_64-dvd1.iso | TRUE      | The path where the user places the ISO image that needs to be provisioned   in target nodes.                                                                                                                                                                                                                                    | Provision |
+----------------------------------+---------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+
| timezone                         | GMT                                         | TRUE      | The timezone that will be set during provisioning of OS. Available   timezones are provided in provision/roles/xcat/files/timezone.txt.                                                                                                                                                                                         | Provision |
+----------------------------------+---------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+
| language                         | en-US                                       | TRUE      | The language that will be set during provisioning of the OS                                                                                                                                                                                                                                                                     | Provision |
+----------------------------------+---------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+
| default_lease_time               | 86400                                       | TRUE      | Default lease time in seconds that will be used by DHCP.                                                                                                                                                                                                                                                                        | Provision |
+----------------------------------+---------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+
| provision_password               |                                             | TRUE      | Password used while deploying OS on bare metal servers. The Length of the   password should be at least 8 characters. The password must not contain -,\,   ',".                                                                                                                                                                 | Provision |
+----------------------------------+---------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+
| postgresdb_password              |                                             | TRUE      | Password used to authenticate into the PostGresDB used by xCAT. Only   alphanumeric characters (no special characters) are accepted.                                                                                                                                                                                            | Provision |
+----------------------------------+---------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+
| primary_dns                      |                                             | FALSE     | The primary DNS host IP queried to provide Internet access to Compute   Node (through DHCP routing)                                                                                                                                                                                                                             | Provision |
+----------------------------------+---------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+
| secondary_dns                    |                                             | FALSE     | The secondary DNS host IP queried to provide Internet access to Compute   Node (through DHCP routing)                                                                                                                                                                                                                           | Provision |
+----------------------------------+---------------------------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+

.. warning:: The IP address *192.168.25.x* is used for PowerVault Storage communications. Therefore, do not use this IP address for other configurations.

2. Provided that the ``host_mapping_file_path`` is updated as per the provided template (Omnia/examples/pxe_mapping_file.csv), Omnia deploys the control plane and assigns the component roles by executing the ``omnia.yml`` file.  To deploy the Omnia control plane, run the following command ::

    ansible-playbook provision.yml

3. By running ``provision.yml``, the following configurations take place:

    i. All available compute nodes will be PXE booted to have IP addresses and host names as specified in ``omnia/input/provision.yml``.

    ii. All ports required for xCAT to run will be opened (For a complete list, check out the `Security Configuration Document <../../SecurityConfigGuide/PortsUsed/xCAT.html>`_).

    iii. A PostgreSQL database is set up with all relevant cluster information such as MAC IDs, service tags, infiniband IPs, BMC IPs etc.

            To access the DB, run:

                        ``psql -U postgres``

                        ``\c omniadb``


            To view the schema being used in the cluster: ``\dn``

            To view the tables in the database: ``\dt``

            To view the contents of the ``nodeinfo`` table: ``select * from cluster.nodeinfo``

    iv. Offline repositories will be created based on the OS being deployed across the cluster.

.. note:: If the cluster does not have access to the internet, AppStream will not function. Please use the available offline repositories instead.

.. warning:: Once xCAT is installed, restart your SSH session to the control plane to ensure that the newly set up environment variables come into effect.